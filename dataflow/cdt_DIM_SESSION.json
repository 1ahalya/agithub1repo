{
	"name": "cdt_DIM_SESSION",
	"properties": {
		"folder": {
			"name": "Common Dim Tables"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "IRDGMI_UT_SRC",
						"type": "DatasetReference"
					},
					"name": "srcSession",
					"description": "Import data from SIS.SESSION"
				},
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "srcDimSession",
					"description": "Import existing records  from DWH.DIM_SESSION"
				},
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "srcMaxDimSessionKey",
					"description": "Get max SESSION_KEY"
				},
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "srcYearsBeforeCurrentAmt",
					"description": "Run query to compute YEARS_BEFORE_CURRENT_AMT"
				},
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "srcSessionsBeforeCurrentAmt",
					"description": "Run query to compute SESSIONS_BEFORE_CURRENT_AMT"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "sinkDimSessionInsert"
				},
				{
					"dataset": {
						"referenceName": "IRDGMI_DWH",
						"type": "DatasetReference"
					},
					"name": "sinkDimSessionUpdate"
				}
			],
			"transformations": [
				{
					"name": "expColumns2",
					"description": "Calculate subset of columns"
				},
				{
					"name": "expColumns3",
					"description": "Calculate subset of columns"
				},
				{
					"name": "lkpYearsBeforeCurrentAmt",
					"description": "Lookup 'srcYearsBeforeCurrentAmt' to calculate YEARS_BEFORE_CURRENT_AMT"
				},
				{
					"name": "lkpSessionsBeforeCurrentAmt",
					"description": "Lookup 'srcSessionsBeforeCurrentAmt' to calculate SESSIONS_BEFORE_CURRENT_AMT"
				},
				{
					"name": "expColumns1",
					"description": "Trim SESSION_CD and other source columns"
				},
				{
					"name": "lkpSessionKey",
					"description": "Lookup DIM_SESSION for existing record"
				},
				{
					"name": "SplitRowsToInsertOrUpdate"
				},
				{
					"name": "genNewKeySequence"
				},
				{
					"name": "genSessionKey"
				},
				{
					"name": "lkpMaxSessionKey"
				},
				{
					"name": "filterRecordsToUpdate"
				},
				{
					"name": "UpdateRowCondition"
				}
			],
			"scriptLines": [
				"source(output(",
				"          SESSION_CD as string,",
				"          LEVEL_OF_INSTR as string,",
				"          LOG_COUNTER as integer,",
				"          PARENT_SES_CD as string,",
				"          SES_END_DT as date,",
				"          SES_START_DT as date,",
				"          SES_ENGLISH_NAME as string,",
				"          SES_FRENCH_NAME as string,",
				"          FEES_ACTIVE_IND as string,",
				"          INSTANT_CALC_IND as string,",
				"          LIBRARY_XFER_TMST as timestamp,",
				"          ALUMNI_XFER_TMST as timestamp,",
				"          FEE_SUB_SESSION_CD as string,",
				"          CAN_HP_TRANS_CD as string,",
				"          FRGN_HP_TRANS_CD as string,",
				"          REFUND_CRIT_CD as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> srcSession",
				"source(output(",
				"          SESSION_KEY as integer,",
				"          s_SESSION_CD as string,",
				"          s_SES_END_DT as date,",
				"          s_SES_START_DT as date,",
				"          s_SES_ENGLISH_NAME as string,",
				"          s_FEES_ACTIVE_IND as string,",
				"          s_CURRENT_SESSION_IND as string,",
				"          s_PARENT_SESSION_CD as string,",
				"          s_SUMMER_TERM1 as string,",
				"          s_SUMMER_TERM2 as string,",
				"          s_ACADEMIC_PERIOD as string,",
				"          s_FISCAL_YR as string,",
				"          s_ACADEMIC_YR as string,",
				"          s_CALENDAR_YR as string,",
				"          s_SESSION_YEAR_AS_INT as short,",
				"          s_SESSION_AS_INT as short,",
				"          s_SESSION_MONTH_AS_INT as short,",
				"          s_SES_ENGLISH_NAME2 as string,",
				"          s_YEARS_BEFORE_CURRENT_AMT as short,",
				"          s_SESSIONS_BEFORE_CURRENT_AMT as short,",
				"          s_SESSION_TYPE as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [SESSION_KEY], [SESSION_CD] AS s_SESSION_CD, [SES_END_DT] AS s_SES_END_DT, [SES_START_DT] AS s_SES_START_DT, [SES_ENGLISH_NAME] AS s_SES_ENGLISH_NAME, [FEES_ACTIVE_IND] AS s_FEES_ACTIVE_IND, \\r\\n[CURRENT_SESSION_IND] AS s_CURRENT_SESSION_IND, [PARENT_SESSION_CD] AS s_PARENT_SESSION_CD, [SUMMER_TERM1] AS s_SUMMER_TERM1, [SUMMER_TERM2] AS s_SUMMER_TERM2, [ACADEMIC_PERIOD] AS s_ACADEMIC_PERIOD, \\r\\n[FISCAL_YR] AS s_FISCAL_YR, [ACADEMIC_YR] AS s_ACADEMIC_YR, [CALENDAR_YR] AS s_CALENDAR_YR, [SESSION_YEAR_AS_INT] AS s_SESSION_YEAR_AS_INT, [SESSION_AS_INT] AS s_SESSION_AS_INT, [SESSION_MONTH_AS_INT] AS s_SESSION_MONTH_AS_INT, \\r\\n[SES_ENGLISH_NAME2] AS s_SES_ENGLISH_NAME2, [YEARS_BEFORE_CURRENT_AMT] AS s_YEARS_BEFORE_CURRENT_AMT, [SESSIONS_BEFORE_CURRENT_AMT] AS s_SESSIONS_BEFORE_CURRENT_AMT, [SESSION_TYPE] AS s_SESSION_TYPE\\r\\nFROM [DWH].[DIM_SESSION]',",
				"     format: 'query') ~> srcDimSession",
				"source(output(",
				"          max_SESSION_KEY as integer,",
				"          lkp_max_key as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT ISNULL(MAX(SESSION_KEY), 0) AS max_SESSION_KEY, 1 AS lkp_max_key FROM DWH.DIM_SESSION',",
				"     format: 'query') ~> srcMaxDimSessionKey",
				"source(output(",
				"          srcYearsBefore_SESSION_CD as string,",
				"          YEARS_BEFORE_CURRENT_AMT as short",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT SESSION_CD AS srcYearsBefore_SESSION_CD, NUMBER_OF_YEARS AS YEARS_BEFORE_CURRENT_AMT FROM\\r\\n(SELECT A.SESSION_CD AS SESSION_CD, (CONVERT(SMALLINT, SUBSTRING((SELECT SESSION_CD FROM DWH.DIM_SESSION WHERE PARENT_SESSION_CD = \\'\\' \\r\\nAND SES_START_DT <= CONVERT(DATE, GETDATE()) \\r\\nAND SES_END_DT >= CONVERT(DATE, GETDATE()) \\r\\nAND SESSION_KEY <> 1),1,4)) - CONVERT(SMALLINT,SUBSTRING(A.SESSION_CD,1,4))) as NUMBER_OF_YEARS\\r\\nFROM DWH.DIM_SESSION A\\r\\nWHERE A.PARENT_SESSION_CD = \\'\\'\\r\\nAND A.SESSION_CD <= (SELECT SESSION_CD FROM DWH.DIM_SESSION \\r\\n                         WHERE PARENT_SESSION_CD = \\'\\'\\r\\n                         AND SES_START_DT <= CONVERT(DATE, GETDATE())\\r\\n                         AND SES_END_DT >= CONVERT(DATE, GETDATE())\\r\\n                         AND SESSION_KEY <> 1)\\r\\n) B',",
				"     format: 'query') ~> srcYearsBeforeCurrentAmt",
				"source(output(",
				"          srcSessionsBefore_SESSION_CD as string,",
				"          COUNT_OF_SESSIONS as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT D.SESSION_CD AS srcSessionsBefore_SESSION_CD, D.COUNT_OF_SESSIONS AS SESSIONS_BEFORE_CURRENT_AMT\\r\\nFROM\\r\\n(\\r\\n(SELECT A.SESSION_CD AS SESSION_CD, COUNT(B.SESSION_CD) AS COUNT_OF_SESSIONS\\r\\nFROM DWH.DIM_SESSION A, DWH.DIM_SESSION B\\r\\nWHERE A.PARENT_SESSION_CD = \\'\\'\\r\\nAND B.PARENT_SESSION_CD = \\'\\'\\r\\nAND A.SESSION_CD <= (SELECT SESSION_CD FROM DWH.DIM_SESSION \\r\\n                         WHERE PARENT_SESSION_CD = \\'\\'\\r\\n                         AND SES_START_DT <= CONVERT(DATE, GETDATE())\\r\\n                         AND SES_END_DT >= CONVERT(DATE, GETDATE())\\r\\n                         AND SESSION_KEY <> 1)\\r\\nAND B.SESSION_CD >= A.SESSION_CD\\r\\nAND B.SESSION_CD < (SELECT SESSION_CD FROM DWH.DIM_SESSION \\r\\n                         WHERE PARENT_SESSION_CD = \\'\\'\\r\\n                         AND SES_START_DT <= CONVERT(DATE, GETDATE())\\r\\n                         AND SES_END_DT >= CONVERT(DATE, GETDATE())\\r\\n                         AND SESSION_KEY <> 1)\\r\\n\\r\\nGROUP BY A.SESSION_CD)\\r\\n\\r\\nUNION\\r\\n\\r\\nSELECT SESSION_CD AS SESSION_CD, 0 AS COUNT_OF_SESSIONS\\r\\nFROM\\r\\n(SELECT SESSION_CD FROM DWH.DIM_SESSION \\r\\n                         WHERE PARENT_SESSION_CD = \\'\\'\\r\\n                         AND SES_START_DT <= CONVERT(DATE, GETDATE())\\r\\n                         AND SES_END_DT >= CONVERT(DATE, GETDATE())\\r\\n                         AND SESSION_KEY <> 1) C\\r\\n) D\\r\\n',",
				"     format: 'query') ~> srcSessionsBeforeCurrentAmt",
				"expColumns1 derive(FEES_ACTIVE_IND = iif(equals(trim(FEES_ACTIVE_IND), ''), 'N', FEES_ACTIVE_IND),",
				"          CURRENT_SESSION_IND = iif(and(equals(trim(PARENT_SES_CD),''), and(greaterOrEqual(currentDate(), SES_START_DT), lesserOrEqual(currentDate(), SES_END_DT))), 'Y', 'N'),",
				"          FISCAL_YR = trim(case(or(equals(substring(SESSION_CD, 5, 1), '5'), equals(substring(SESSION_CD, 5, 1), '9')), \r",
				"concat(substring(SESSION_CD, 1, 4), '/', toString(add(toInteger(substring(SESSION_CD, 1, 4)), 1))), \r",
				"equals(substring(SESSION_CD, 5, 1), '1'), \r",
				"concat(toString(minus(toInteger(substring(SESSION_CD, 1, 4)), 1)), '/', substring(SESSION_CD, 1, 4)), \r",
				"'')),",
				"          ACADEMIC_YR = trim(case(equals(substring(SESSION_CD, 5, 1), '9'), \r",
				"concat(substring(SESSION_CD, 1, 4), '/', toString(add(toInteger(substring(SESSION_CD, 1, 4)), 1))), \r",
				"or(equals(substring(SESSION_CD, 5, 1), '1'), equals(substring(SESSION_CD, 5, 1), '5')), \r",
				"concat(toString(minus(toInteger(substring(SESSION_CD, 1, 4)), 1)), '/', substring(SESSION_CD, 1, 4)), \r",
				"'')),",
				"          CALENDAR_YR = substring(SESSION_CD, 1, 4),",
				"          SUMMER_TERM1 = iif(equals(substring(PARENT_SES_CD, 5, 1), '5'), concat(trim(PARENT_SES_CD), 'F'), ''),",
				"          SUMMER_TERM2 = iif(equals(substring(PARENT_SES_CD, 5, 1), '5'), concat(trim(PARENT_SES_CD), 'S'), ''),",
				"          ACADEMIC_PERIOD = case(\r",
				"    equals(substring(SESSION_CD, 1, 5), '99999'), '99999',\r",
				"    equals(substring(SESSION_CD, 5, 1), '9'), concat(SESSION_CD, '/', toString(add(toInteger(SESSION_CD), 2))), \r",
				"    equals(substring(SESSION_CD, 5, 1), '1'), concat(toString(minus(toInteger(SESSION_CD), 2)), '/', SESSION_CD),\r",
				"    equals(substring(SESSION_CD, 5, 1), '5'), substring(SESSION_CD, 1, 5),\r",
				"SESSION_CD),",
				"          SES_ENGLISH_NAME2 = case(\r",
				"    equals(SESSION_CD, 'N/A'), 'N/A', \r",
				"    equals(substring(SESSION_CD, 5, 1), '1'), concat('Winter ', substring(SESSION_CD, 0, 4)),\r",
				"    equals(substring(SESSION_CD, 5, 1), '9'), concat('Fall ', substring(SESSION_CD, 0, 4)),\r",
				"    equals(substring(SESSION_CD, 5, 1), '5'),\r",
				"    case(\r",
				"        equals(substring(SESSION_CD, 6, 1), 'F'), concat('Summer May-Jun ', substring(SESSION_CD, 0, 4)),\r",
				"        equals(substring(SESSION_CD, 6, 1), 'S'), concat('Summer Jul-Aug ', substring(SESSION_CD, 0, 4)),\r",
				"        concat('Summer ', substring(SESSION_CD, 0, 4))\r",
				"    ),\r",
				"''),",
				"          SESSION_TYPE = case(equals(SESSION_CD, '99999'), 'N/A',\r",
				"equals(substring(SESSION_CD, 5, 1), '1'), 'Winter',\r",
				"equals(substring(SESSION_CD, 5, 1), '5'), 'Summer',\r",
				"equals(substring(SESSION_CD, 5, 1), '9'), 'Fall',\r",
				"'N/A')) ~> expColumns2",
				"expColumns2 derive(SESSION_YEAR_AS_INT = iif(equals(SESSION_CD, '99999'), 0, toInteger(CALENDAR_YR)),",
				"          SESSION_AS_INT = iif(equals(SESSION_CD, '99999'), 0, toInteger(SESSION_CD)),",
				"          SESSION_MONTH_AS_INT = iif(equals(SESSION_CD, '99999'), 0, toInteger(substring(SESSION_CD, 5, 1))),",
				"          FISCAL_YR = substring(FISCAL_YR, 1, 9),",
				"          ACADEMIC_YR = substring(ACADEMIC_YR, 1, 9),",
				"          src_lkp_max_key = 1) ~> expColumns3",
				"expColumns3, srcYearsBeforeCurrentAmt lookup(trim(SESSION_CD) == trim(srcYearsBefore_SESSION_CD),",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lkpYearsBeforeCurrentAmt",
				"lkpYearsBeforeCurrentAmt, srcSessionsBeforeCurrentAmt lookup(trim(SESSION_CD) == trim(srcSessionsBefore_SESSION_CD),",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lkpSessionsBeforeCurrentAmt",
				"srcSession derive(SESSION_CD = trim(SESSION_CD),",
				"          PARENT_SESSION_CD = trim(PARENT_SES_CD),",
				"          SES_ENGLISH_NAME = trim(SES_ENGLISH_NAME)) ~> expColumns1",
				"lkpSessionsBeforeCurrentAmt, srcDimSession lookup(trim(SESSION_CD) == trim(s_SESSION_CD),",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lkpSessionKey",
				"lkpSessionKey split(isNull(SESSION_KEY),",
				"     disjoint: true) ~> SplitRowsToInsertOrUpdate@(InsertStream, UpdateStream)",
				"SplitRowsToInsertOrUpdate@InsertStream keyGenerate(output(SESSION_KEY as long),",
				"     startAt: 1L,",
				"     stepValue: 1L) ~> genNewKeySequence",
				"lkpMaxSessionKey derive(SESSION_KEY = add(SESSION_KEY, max_SESSION_KEY)) ~> genSessionKey",
				"genNewKeySequence, srcMaxDimSessionKey lookup(src_lkp_max_key == lkp_max_key,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> lkpMaxSessionKey",
				"SplitRowsToInsertOrUpdate@UpdateStream filter(case(\r",
				"    notEquals(SES_START_DT, s_SES_START_DT), true(),\r",
				"    notEquals(SES_END_DT, s_SES_END_DT), true(),\r",
				"    notEquals(SES_ENGLISH_NAME, s_SES_ENGLISH_NAME), true(),\r",
				"    notEquals(FEES_ACTIVE_IND, s_FEES_ACTIVE_IND), true(),\r",
				"    notEquals(CURRENT_SESSION_IND, s_CURRENT_SESSION_IND), true(),\r",
				"    notEquals(trim(PARENT_SESSION_CD), trim(s_PARENT_SESSION_CD)), true(),\r",
				"    notEquals(trim(SUMMER_TERM1), trim(s_SUMMER_TERM1)), true(),\r",
				"    notEquals(trim(SUMMER_TERM2), trim(s_SUMMER_TERM2)), true(),\r",
				"    notEquals(trim(ACADEMIC_PERIOD), trim(s_ACADEMIC_PERIOD)), true(),\r",
				"    notEquals(trim(FISCAL_YR), trim(s_FISCAL_YR)), true(),\r",
				"    notEquals(trim(ACADEMIC_YR), trim(s_ACADEMIC_YR)), true(),\r",
				"    notEquals(trim(CALENDAR_YR), trim(s_CALENDAR_YR)), true(),\r",
				"    notEquals(SESSION_YEAR_AS_INT, s_SESSION_YEAR_AS_INT), true(),\r",
				"    notEquals(SESSION_AS_INT, s_SESSION_AS_INT), true(),\r",
				"    notEquals(SESSION_MONTH_AS_INT, s_SESSION_MONTH_AS_INT), true(),\r",
				"    notEquals(trim(SES_ENGLISH_NAME2), trim(s_SES_ENGLISH_NAME2)), true(),\r",
				"    notEquals(YEARS_BEFORE_CURRENT_AMT, s_YEARS_BEFORE_CURRENT_AMT), true(),\r",
				"    notEquals(s_SESSIONS_BEFORE_CURRENT_AMT, s_SESSIONS_BEFORE_CURRENT_AMT), true(),\r",
				"    notEquals(trim(SESSION_TYPE), trim(s_SESSION_TYPE)), true(),\r",
				"    false()\r",
				")) ~> filterRecordsToUpdate",
				"filterRecordsToUpdate alterRow(updateIf(true())) ~> UpdateRowCondition",
				"genSessionKey sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          SESSION_KEY as integer,",
				"          SESSION_CD as string,",
				"          SES_END_DT as date,",
				"          SES_START_DT as date,",
				"          SES_ENGLISH_NAME as string,",
				"          FEES_ACTIVE_IND as string,",
				"          CURRENT_SESSION_IND as string,",
				"          PARENT_SESSION_CD as string,",
				"          SUMMER_TERM1 as string,",
				"          SUMMER_TERM2 as string,",
				"          ACADEMIC_PERIOD as string,",
				"          FISCAL_YR as string,",
				"          ACADEMIC_YR as string,",
				"          CALENDAR_YR as string,",
				"          SESSION_YEAR_AS_INT as integer,",
				"          SESSION_AS_INT as integer,",
				"          SESSION_MONTH_AS_INT as integer,",
				"          SES_ENGLISH_NAME2 as string,",
				"          YEARS_BEFORE_CURRENT_AMT as integer,",
				"          SESSIONS_BEFORE_CURRENT_AMT as integer,",
				"          SESSION_TYPE as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> sinkDimSessionInsert",
				"UpdateRowCondition sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          SESSION_KEY as integer,",
				"          SESSION_CD as string,",
				"          SES_END_DT as date,",
				"          SES_START_DT as date,",
				"          SES_ENGLISH_NAME as string,",
				"          FEES_ACTIVE_IND as string,",
				"          CURRENT_SESSION_IND as string,",
				"          PARENT_SESSION_CD as string,",
				"          SUMMER_TERM1 as string,",
				"          SUMMER_TERM2 as string,",
				"          ACADEMIC_PERIOD as string,",
				"          FISCAL_YR as string,",
				"          ACADEMIC_YR as string,",
				"          CALENDAR_YR as string,",
				"          SESSION_YEAR_AS_INT as integer,",
				"          SESSION_AS_INT as integer,",
				"          SESSION_MONTH_AS_INT as integer,",
				"          SES_ENGLISH_NAME2 as string,",
				"          YEARS_BEFORE_CURRENT_AMT as integer,",
				"          SESSIONS_BEFORE_CURRENT_AMT as integer,",
				"          SESSION_TYPE as string",
				"     ),",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:true,",
				"     upsertable:false,",
				"     keys:['SESSION_KEY'],",
				"     skipKeyWrites:true,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> sinkDimSessionUpdate"
			]
		}
	}
}